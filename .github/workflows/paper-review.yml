name: Scientific Manuscript Review

on:
  push:
    branches:
      - '**'
    paths:
      - 'example_paper.tex'
      - '**/*.tex'

jobs:
  review-paper:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Pull Request
        id: find-pr
        uses: 8BitJonny/gh-get-current-pr@3.0.0
        with:
          filterOutClosed: true
          sha: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Paper Exists
        id: paper-content
        run: |
          if [ -f "example_paper.tex" ]; then
            echo "paper_exists=true" >> $GITHUB_OUTPUT
          else
            echo "paper_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Claude Scientific Manuscript Review
        if: steps.find-pr.outputs.pr_found == 'true' && steps.paper-content.outputs.paper_exists == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are reviewing a scientific manuscript for ICML 2025.

            ## Task
            Review `example_paper.tex` using systematic scientific manuscript review.

            ## Review Framework

            1. **Core Message**: Identify the ONE central finding
            2. **Structure**: Evaluate IMRaD organization
            3. **Scientific Clarity**: Check claims, statistics, hedging
            4. **ICML Criteria**: Novelty, technical correctness, rigor

            ## Output Format

            ## Summary
            [1-2 sentence overview]

            ## Strengths
            - [Key strengths]

            ## Weaknesses
            - [Areas for improvement]

            ## Section Feedback

            ### Introduction
            [Feedback on gap statement and structure]

            ### Methods
            [Feedback on clarity and reproducibility]

            ### Results
            [Feedback on presentation and interpretation]

            ### Discussion
            [Feedback on claims and limitations]

            ## Recommendations
            [Prioritized improvements before submission]

            ---
            *Review by Claude using scientific-manuscript-review methodology*
          claude_args: |
            --max-turns 20
            --allowedTools Read,Glob,Grep,Bash(cat),Bash(head)

      - name: Review Summary
        run: |
          echo "## Paper Review Complete"
          echo "- PR Found: ${{ steps.find-pr.outputs.pr_found }}"
          echo "- Paper Exists: ${{ steps.paper-content.outputs.paper_exists }}"
